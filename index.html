<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NS Psycho â€” Weekly Tracker</title>
<style>
  :root { --fg:#111; --bg:#fff; --muted:#6a6a6a; --line:#e6e6e6; --ink:#000; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.42 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid var(--ink);padding:6px 10px;border-radius:999px;background:#fff;color:#000;cursor:pointer}
  .pill[aria-pressed="true"]{background:#000;color:#fff}
  main{max-width:980px;margin:0 auto;padding:20px}
  h2{font-size:18px;margin:0 0 10px;font-weight:700}
  h3{font-size:15px;margin:16px 0 8px;font-weight:700}
  .muted{color:var(--muted)} .small{font-size:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:880px){ .grid3{grid-template-columns:1fr 1fr} }
  .btn{border:1px solid var(--ink);background:#fff;color:#000;padding:8px 12px;border-radius:6px;cursor:pointer}
  .btn.primary{background:#000;color:#fff}
  .btn.ghost{border-color:#bbb;color:#111}
  .chip{display:inline-block;border:1px solid #000;border-radius:999px;padding:4px 10px;margin:3px 6px 3px 0;cursor:pointer}
  .chip.on{background:#000;color:#fff}
  .card{border:1px solid #000;border-radius:8px;padding:16px;background:#fff}
  .item{padding:10px 12px;border:1px solid var(--line);border-radius:6px;margin:8px 0}
  label{display:block;margin:8px 0 6px}
  table{border-collapse:collapse;width:100%;font-size:14px}
  th,td{border:1px solid var(--line);padding:6px 8px;text-align:left}
  .bar{height:140px;border:1px solid var(--line);border-radius:6px;display:flex;align-items:flex-end;gap:6px;padding:8px;overflow-x:auto}
  .bar div{width:16px;background:#000}
  .progress{height:8px;background:#f3f3f3;border:1px solid var(--line);border-radius:4px;overflow:hidden}
  .progress>div{height:8px;background:#000}
  .center{display:flex;justify-content:center;align-items:center;text-align:center}
  .overlay{border:1px solid #000;border-radius:12px;padding:28px;max-width:560px;margin:40px auto;background:#fff}
  .stepper{display:flex;gap:8px;align-items:center;margin:6px 0 16px}
  .step{display:flex;align-items:center;gap:8px}
  .dot{width:22px;height:22px;border-radius:50%;border:1px solid #000;display:inline-grid;place-items:center;font-size:12px}
  .dot.active{background:#000;color:#fff}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:#f5f5f5;border:1px solid #ccc;padding:1px 6px;border-radius:4px}
</style>
</head>
<body>
<header>
  <h1>NS Psychometric â€” Weekly Tracker</h1>
  <nav>
    <button class="pill" id="nav-setup"   aria-pressed="true">Setup</button>
    <button class="pill" id="nav-checkin">Weekly Checkâ€‘In</button>
    <button class="pill" id="nav-dash">Dashboard</button>
    <button class="pill" id="nav-corr">Correlations</button>
    <button class="pill" id="nav-data">Data</button>
  </nav>
  <span class="small muted" style="margin-left:auto">All data stored locally</span>
</header>

<main>
  <section id="panel"></section>
</main>

<script>
/* =========================
   Utilities & Storage
   ========================= */
const byId=id=>document.getElementById(id);
const todayISO=()=>new Date().toISOString().slice(0,10);
function isoWeekKey(date=new Date()){
  const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
  const yStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const w=Math.ceil((((d-yStart)/86400000)+1)/7);
  return `${d.getUTCFullYear()}-W${String(w).padStart(2,'0')}`;
}
function weekKeyFromInput(val){ return val && /^\d{4}-W\d{2}$/.test(val) ? val : isoWeekKey(new Date()); }
const STORE_KEY="nspsycho_v3";
function load(){
  try{
    const x=JSON.parse(localStorage.getItem(STORE_KEY));
    if(!x) throw 0;
    if(Array.isArray(x.data)){ x.data.forEach(e=>{ if(!e.week && e.date) e.week = isoWeekKey(new Date(e.date)); }); }
    if(!x.areas) x.areas=[];
    if(!x.assigned) x.assigned={};
    if(!x.meta) x.meta={};
    return x;
  }catch{
    return {areas:[],assigned:{},data:[],meta:{}};
  }
}
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

/* =========================
   Areas & Instruments (full)
   ========================= */
const AREAS=[
  {id:"wellbeing", name:"Wellâ€‘Being"},
  {id:"depression", name:"Depression"},
  {id:"anxiety", name:"Anxiety / Distress"},
  {id:"functioning", name:"Functioning"},
  {id:"resilience", name:"Resilience"},
  {id:"ptsd", name:"PTSD"},
  {id:"somatic", name:"Somatic"},
  {id:"eating", name:"Eating"},
  {id:"relationships", name:"Relationships / Attachment"},
  {id:"ocd", name:"OCD"},
  {id:"nondual", name:"Nonâ€‘dual / Nonattachment"},
];
const CHOICES={
  phq_gad:[{label:"Not at all",v:0},{label:"Several days",v:1},{label:"More than half the days",v:2},{label:"Nearly every day",v:3}],
  who5:[{label:"At no time",v:0},{label:"Some of the time",v:1},{label:"Less than half the time",v:2},{label:"More than half the time",v:3},{label:"Most of the time",v:4},{label:"All of the time",v:5}],
  k10:[{label:"None of the time",v:1},{label:"A little of the time",v:2},{label:"Some of the time",v:3},{label:"Most of the time",v:4},{label:"All of the time",v:5}],
  brs:[{label:"Strongly disagree",v:1},{label:"Disagree",v:2},{label:"Neutral",v:3},{label:"Agree",v:4},{label:"Strongly agree",v:5}],
  pcl5:[{label:"Not at all",v:0},{label:"A little bit",v:1},{label:"Moderately",v:2},{label:"Quite a bit",v:3},{label:"Extremely",v:4}],
  phq15:[{label:"Not bothered at all",v:0},{label:"Bothered a little",v:1},{label:"Bothered a lot",v:2}],
  yesno:[{label:"No",v:0},{label:"Yes",v:1}],
  whodas:[{label:"None",v:0},{label:"Mild",v:1},{label:"Moderate",v:2},{label:"Severe",v:3},{label:"Extreme / cannot do",v:4}],
  ecrs:[{label:"Strongly disagree",v:1},{label:"Disagree",v:2},{label:"Slightly disagree",v:3},{label:"Neutral",v:4},{label:"Slightly agree",v:5},{label:"Agree",v:6},{label:"Strongly agree",v:7}],
  nas7:[{label:"Strongly disagree",v:1},{label:"Disagree",v:2},{label:"Slightly disagree",v:3},{label:"Slightly agree",v:4},{label:"Agree",v:5},{label:"Strongly agree",v:6}],
  docsSF:[{label:"0",v:0},{label:"1",v:1},{label:"2",v:2},{label:"3",v:3},{label:"4",v:4},{label:"5",v:5},{label:"6",v:6},{label:"7",v:7},{label:"8",v:8}]
};
const SCALES=[
  {id:"PHQ8", title:"PHQâ€‘8 (Depression)", area:"depression", choices:CHOICES.phq_gad, normMax:24,
   items:["Little interest or pleasure in doing things.","Feeling down, depressed, or hopeless.","Trouble falling or staying asleep, or sleeping too much.","Feeling tired or having little energy.","Poor appetite or overeating.","Feeling bad about yourself â€” or that you are a failure or have let yourself or your family down.","Trouble concentrating on things, such as reading or watching television.","Moving or speaking so slowly that other people could have noticed â€” or the opposite: being so fidgety or restless that you have been moving around a lot more than usual."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"GAD7", title:"GADâ€‘7 (Anxiety)", area:"anxiety", choices:CHOICES.phq_gad, normMax:21,
   items:["Feeling nervous, anxious, or on edge.","Not being able to stop or control worrying.","Worrying too much about different things.","Trouble relaxing.","Being so restless that itâ€™s hard to sit still.","Becoming easily annoyed or irritable.","Feeling afraid as if something awful might happen."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"WHO5", title:"WHOâ€‘5 Wellâ€‘Being Index", area:"wellbeing", choices:CHOICES.who5, normMax:100,
   items:["I have felt cheerful and in good spirits.","I have felt calm and relaxed.","I have felt active and vigorous.","I woke up feeling fresh and rested.","My daily life has been filled with things that interest me."],
   score:vals=>Math.round(vals.reduce((a,b)=>a+b,0)*4)},
  {id:"K10", title:"K10 (Psychological Distress)", area:"anxiety", choices:CHOICES.k10, normMax:50,
   items:["During the last 30 days, about how often did you feel tired out for no good reason?","During the last 30 days, about how often did you feel nervous?","â€¦so nervous that nothing could calm you down?","â€¦hopeless?","â€¦restless or fidgety?","â€¦so restless you could not sit still?","â€¦depressed?","â€¦that everything was an effort?","â€¦so sad that nothing could cheer you up?","â€¦worthless?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"BRS6", title:"Brief Resilience Scale (6)", area:"resilience", choices:CHOICES.brs, normMax:30,
   items:["I tend to bounce back quickly after hard times.","I have a hard time making it through stressful events.","It does not take me long to recover from a stressful event.","It is hard for me to snap back when something bad happens.","I usually come through difficult times with little trouble.","I tend to take a long time to get over setâ€‘backs in my life."],
   score:vals=>{const rev=[1,3,5];return vals.map((v,i)=>rev.includes(i)?(6-v):v).reduce((a,b)=>a+b,0)}},
  {id:"WHODAS12", title:"WHODAS 2.0 (12â€‘item)", area:"functioning", choices:CHOICES.whodas, normMax:48,
   items:["Standing for long periods such as 30 minutes?","Taking care of your household responsibilities?","Learning a new task, for example, learning how to get to a new place?","Joining in community activities in the same way as anyone else can?","How much have you been emotionally affected by your health problems?","Concentrating on doing something for ten minutes?","Walking a long distance such as a kilometre [or equivalent]?","Washing your whole body?","Getting dressed?","Dealing with people you do not know?","Maintaining a friendship?","Your dayâ€‘toâ€‘day work?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"PHQ15", title:"PHQâ€‘15 (Somatic Symptoms)", area:"somatic", choices:CHOICES.phq15, normMax:30,
   items:["Stomach pain","Back pain","Pain in your arms, legs, or joints (knees, hips, etc.)","Menstrual cramps or other problems with your periods (women only â€” if not applicable choose â€˜Not bothered at allâ€™)","Headaches","Chest pain","Dizziness","Fainting spells","Feeling your heart pound or race","Shortness of breath","Pain or problems during sexual intercourse","Constipation, loose bowels, or diarrhea","Nausea, gas, or indigestion","Feeling tired or having low energy","Trouble sleeping"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"SCOFF", title:"SCOFF (Eatingâ€‘Disorder Screen)", area:"eating", choices:CHOICES.yesno, normMax:5,
   items:["Do you make yourself Sick because you feel uncomfortably full?","Do you worry you have lost Control over how much you eat?","Have you recently lost more than One stone (â‰ˆ6.5â€¯kg) in a threeâ€‘month period?","Do you believe yourself to be Fat when others say you are too thin?","Would you say that Food dominates your life?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"PCL5", title:"PCLâ€‘5 (PTSD, past month)", area:"ptsd", choices:CHOICES.pcl5, normMax:80,
   items:["Repeated, disturbing, and unwanted memories of the stressful experience?","Repeated, disturbing dreams of the stressful experience?","Suddenly feeling or acting as if the stressful experience were actually happening again?","Feeling very upset when something reminded you of the stressful experience?","Having strong physical reactions when something reminded you of the stressful experience (for example, heart pounding, trouble breathing, sweating)?","Avoiding memories, thoughts, or feelings related to the stressful experience?","Avoiding external reminders of the stressful experience (for example, people, places, conversations, activities, objects, or situations)?","Trouble remembering important parts of the stressful experience?","Having strong negative beliefs about yourself, other people, or the world?","Blaming yourself or someone else for the stressful experience or what happened after it?","Having strong negative feelings such as fear, horror, anger, guilt, or shame?","Loss of interest in activities that you used to enjoy?","Feeling distant or cut off from other people?","Trouble experiencing positive feelings (for example, being unable to feel happiness or have loving feelings for people close to you)?","Irritable behavior, angry outbursts, or acting aggressively?","Taking too many risks or doing things that could cause you harm?","Being â€œsuperalertâ€ or watchful or on guard?","Feeling jumpy or easily startled?","Having difficulty concentrating?","Trouble falling or staying asleep?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"ECRS12", title:"ECRâ€‘S (Attachment, 12)", area:"relationships", choices:CHOICES.ecrs, normMax:84,
   items:["It helps to turn to my romantic partner in times of need.","I need a lot of reassurance that I am loved by my partner.","I want to get close to my partner, but I keep pulling back.","I find that my partner(s) donâ€™t want to get as close as I would like.","I turn to my partner for many things, including comfort and reassurance.","My desire to be very close sometimes scares people away.","I try to avoid getting too close to my partner.","I do not often worry about being abandoned.","I usually discuss my problems and concerns with my partner.","I get frustrated if romantic partners are not available when I need them.","I am nervous when partners get too close to me.","I worry that romantic partners wonâ€™t care about me as much as I care about them."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"NAS7", title:"NASâ€‘7 (Nonâ€‘attachment)", area:"nondual", choices:CHOICES.nas7, normMax:42,
   items:["I can let go of regrets and feelings of dissatisfaction about the past.","I can enjoy pleasant experiences without needing them to last forever.","I view the problems that enter my life as things to work on rather than reasons for becoming disheartened or demoralized.","I can enjoy my family and friends without feeling I need to hang on to them.","I can take joy in othersâ€™ achievements without feeling envious.","I do not get â€œhung upâ€ on wanting an â€œidealâ€ or â€œperfectâ€ life.","When pleasant experiences end, I am fine moving on to what comes next."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"DOCS_SF5", title:"OCD Severity (DOCSâ€‘SF style, 5)", area:"ocd", choices:CHOICES.docsSF, normMax:40,
   items:["Past 7 days: time occupied by obsessions/compulsions.","Past 7 days: avoidance due to obsessions/compulsions.","Past 7 days: distress from obsessions/compulsions.","Past 7 days: interference with daily life (home, work, social).","Past 7 days: difficulty refraining from compulsions."],
   score:vals=>vals.reduce((a,b)=>a+b,0)}
];
const DEFAULT_ASSIGN={
  wellbeing:["WHO5","NAS7"],
  depression:["PHQ8"],
  anxiety:["GAD7","K10"],
  functioning:["WHODAS12"],
  resilience:["BRS6"],
  ptsd:["PCL5"],
  somatic:["PHQ15"],
  eating:["SCOFF"],
  relationships:["ECRS12"],
  ocd:["DOCS_SF5"],
  nondual:["NAS7"]
};

/* =========================
   State & Navigation
   ========================= */
let state=load();
AREAS.forEach(a=>{ if(!state.assigned[a.id]) state.assigned[a.id]=DEFAULT_ASSIGN[a.id]||[]; });
save();

let view="setup";        // setup | checkin | dash | corr | data
let setupStep=1;         // 1..3
let currentArea=state.areas[0]||"wellbeing";

byId("nav-setup").onclick = ()=> setView("setup");
byId("nav-checkin").onclick = ()=> setView("checkin");
byId("nav-dash").onclick = ()=> setView("dash");
byId("nav-corr").onclick = ()=> setView("corr");
byId("nav-data").onclick = ()=> setView("data");

function setView(v){
  view=v;
  byId("nav-setup").setAttribute("aria-pressed", v==="setup");
  byId("nav-checkin").setAttribute("aria-pressed", v==="checkin");
  byId("nav-dash").setAttribute("aria-pressed", v==="dash");
  byId("nav-corr").setAttribute("aria-pressed", v==="corr");
  byId("nav-data").setAttribute("aria-pressed", v==="data");
  render();
}
function render(){ if(view==="setup") renderSetup(); if(view==="checkin") renderCheckin(); if(view==="dash") renderDash(); if(view==="corr") renderCorr(); if(view==="data") renderData(); }

/* =========================
   SETUP (wizard) â€” FIXED
   ========================= */
function renderSetup(){
  const p=byId("panel"); p.innerHTML="";
  const stepper=document.createElement("div"); stepper.className="stepper";
  stepper.innerHTML = `
    <div class="step"><div class="dot ${setupStep===1?'active':''}">1</div> Areas</div>
    <div style="width:24px;height:1px;background:var(--line)"></div>
    <div class="step"><div class="dot ${setupStep===2?'active':''}">2</div> Tests</div>
    <div style="width:24px;height:1px;background:var(--line)"></div>
    <div class="step"><div class="dot ${setupStep===3?'active':''}">3</div> Review</div>
  `;
  p.appendChild(stepper);

  // single body container; each step replaces its content
  let body = byId("setupBody");
  if (!body){ body = document.createElement("div"); body.id = "setupBody"; p.appendChild(body); }
  body.innerHTML = ""; // clear before rendering the step

  if(setupStep===1) setupAreas(body);
  if(setupStep===2) setupTests(body);
  if(setupStep===3) setupReview(body);
}

function setupAreas(container){
  const card=document.createElement("div"); card.className="card";
  card.innerHTML = `<h2>Choose focus areas</h2>
    <p class="muted">Pick the domains you want to track weekly.</p>`;
  const grid=document.createElement("div"); grid.className="grid3";
  AREAS.forEach(a=>{
    const wrap=document.createElement("div");
    const b=document.createElement("button");
    const on = state.areas.includes(a.id);
    b.className="pill"; b.setAttribute("aria-pressed", on);
    b.textContent=a.name;
    b.onclick=()=>{
      // update state and re-render WHOLE setup (prevents duplicate cards)
      if(on){
        state.areas = state.areas.filter(x=>x!==a.id);
        if(!state.areas.length) state.areas=[a.id];
        } else {
        state.areas=[...state.areas, a.id];
        }
      save(); renderSetup();
    };
    wrap.appendChild(b);
    grid.appendChild(wrap);
  });
  card.appendChild(grid);

  const row=document.createElement("div"); row.className="row";
  const next=document.createElement("button"); next.className="btn primary"; next.textContent="Next: Choose Tests";
  next.onclick=()=>{ setupStep=2; renderSetup(); };
  row.appendChild(next);
  card.appendChild(row);

  container.appendChild(card);
}

function setupTests(container){
  const card=document.createElement("div"); card.className="card";
  card.innerHTML = `<h2>Choose tests per area</h2>
    <p class="muted">We preselect recommended tests. Toggle any you want to include weekly.</p>`;

  state.areas.forEach(aid=>{
    const areaCard=document.createElement("div"); areaCard.className="card"; areaCard.style.marginTop="10px";
    const name = AREAS.find(x=>x.id===aid).name;
    areaCard.innerHTML = `<strong>${name}</strong>`;

    const controls=document.createElement("div"); controls.className="row";
    const selectAll=document.createElement("button"); selectAll.className="btn ghost"; selectAll.textContent="Select All";
    selectAll.onclick=()=>{ state.assigned[aid]=SCALES.filter(s=>s.area===aid).map(s=>s.id); save(); renderSetup(); };
    const clear=document.createElement("button"); clear.className="btn ghost"; clear.textContent="Clear All";
    clear.onclick=()=>{ state.assigned[aid]=[]; save(); renderSetup(); };
    const restore=document.createElement("button"); restore.className="btn ghost"; restore.textContent="Restore Recommended";
    restore.onclick=()=>{ state.assigned[aid]=[...(DEFAULT_ASSIGN[aid]||[])]; save(); renderSetup(); };
    controls.appendChild(selectAll); controls.appendChild(clear); controls.appendChild(restore);
    areaCard.appendChild(controls);

    const chips=document.createElement("div");
    const selected = new Set(state.assigned[aid]||[]);
    SCALES.filter(s=>s.area===aid).forEach(s=>{
      const chip=document.createElement("span");
      chip.className = "chip" + (selected.has(s.id) ? " on" : "");
      chip.textContent = s.title;
      chip.onclick=()=>{
        const set = new Set(state.assigned[aid]||[]);
        if(set.has(s.id)) set.delete(s.id); else set.add(s.id);
        state.assigned[aid]=Array.from(set);
        save(); renderSetup();
      };
      chips.appendChild(chip);
    });
    areaCard.appendChild(chips);

    card.appendChild(areaCard);
  });

  const row=document.createElement("div"); row.className="row"; row.style.marginTop="8px";
  const back=document.createElement("button"); back.className="btn"; back.textContent="Back";
  back.onclick=()=>{ setupStep=1; renderSetup(); };
  const next=document.createElement("button"); next.className="btn primary"; next.textContent="Next: Review";
  next.onclick=()=>{ setupStep=3; renderSetup(); };
  row.appendChild(back); row.appendChild(next);
  card.appendChild(row);

  container.appendChild(card);
}

function setupReview(container){
  const card=document.createElement("div"); card.className="card";
  card.innerHTML = `<h2>Review & Save</h2>
    <p class="muted">These tests will appear in your Weekly Checkâ€‘In each week.</p>`;
  const table=document.createElement("table");
  table.innerHTML=`<thead><tr><th>Area</th><th>Assigned tests</th></tr></thead><tbody></tbody>`;
  const tb=table.querySelector("tbody");
  state.areas.forEach(a=>{
    const tr=document.createElement("tr");
    const tests=(state.assigned[a]||[]).map(id=>SCALES.find(s=>s.id===id).title).join(", ");
    tr.innerHTML=`<td>${AREAS.find(x=>x.id===a).name}</td><td>${tests||"<span class='muted'>None</span>"}</td>`;
    tb.appendChild(tr);
  });
  card.appendChild(table);
  const row=document.createElement("div"); row.className="row"; row.style.marginTop="8px";
  const back=document.createElement("button"); back.className="btn"; back.textContent="Back";
  back.onclick=()=>{ setupStep=2; renderSetup(); };
  const saveBtn=document.createElement("button"); saveBtn.className="btn primary"; saveBtn.textContent="Save & Start Weekly Checkâ€‘In";
  saveBtn.onclick=()=>{ save(); setView("checkin"); };
  row.appendChild(back); row.appendChild(saveBtn);
  card.appendChild(row);

  const note=document.createElement("p"); note.className="small muted";
  note.innerHTML = "Tip: You can edit assignments anytime in <strong>Setup</strong>. Data stays on this device.";
  card.appendChild(note);
  container.appendChild(card);
}

/* =========================
   WEEKLY CHECKâ€‘IN (unchanged behavior)
   ========================= */
function selectedScaleIds(){
  const ids=new Set();
  (state.areas||[]).forEach(a=> (state.assigned[a]||[]).forEach(id=>ids.add(id)));
  return Array.from(ids);
}
function upsertEntry(entry){
  const i=state.data.findIndex(d=>d.week===entry.week && d.scale===entry.scale);
  if(i>=0) state.data[i]=entry; else state.data.push(entry);
  save();
}
function renderCheckin(){
  const p=byId("panel"); p.innerHTML="";
  const week = isoWeekKey(new Date());
  const head=document.createElement("div"); head.className="row";
  head.innerHTML = `<h2 style="margin:0">Weekly Checkâ€‘In</h2>`;
  const wkWrap=document.createElement("div"); wkWrap.className="row";
  wkWrap.innerHTML = `<label class="small">Week <input type="week" id="weekPick" value="${week}"></label>`;
  const reset=document.createElement("button"); reset.className="btn ghost"; reset.textContent="Reset this week";
  reset.onclick=()=>{ const w=weekKeyFromInput(byId("weekPick").value); if(confirm('Clear all responses for '+w+' ?')){ state.data=state.data.filter(d=>d.week!==w); save(); renderCheckin(); } };
  wkWrap.appendChild(reset);
  p.appendChild(head); p.appendChild(wkWrap);

  const prog=document.createElement("div"); prog.className="progress"; prog.innerHTML=`<div id="progFill" style="width:0%"></div>`;
  const progText=document.createElement("div"); progText.className="small muted"; progText.id="progText"; progText.style.marginTop="6px"; progText.textContent="0 of 0 completed";
  p.appendChild(prog); p.appendChild(progText);

  const container=document.createElement("div"); container.id="queueContainer"; p.appendChild(container);

  function buildQueue(){
    const w=weekKeyFromInput(byId("weekPick").value);
    const all=selectedScaleIds();
    const done=new Set(state.data.filter(d=>d.week===w).map(d=>d.scale));
    const due=all.filter(id=>!done.has(id));
    const pct = all.length? Math.round((all.length-due.length)/all.length*100):0;
    byId("progFill").style.width=pct+"%";
    byId("progText").textContent = `${all.length-due.length} of ${all.length} completed`;
    container.innerHTML="";

    if(all.length===0){
      container.innerHTML = `<div class="overlay center"><div>
        <h2>No tests are assigned</h2>
        <p class="muted">Use <strong>Setup</strong> to choose areas and tests.</p>
        <button class="btn primary" onclick="setView('setup')">Go to Setup</button>
      </div></div>`;
      return;
    }
    if(due.length===0){
      container.innerHTML = `<div class="overlay center"><div>
        <h2>ðŸŽ‰ NO MORE TESTS THIS WEEK</h2>
        <p class="muted">Week <strong>${w}</strong> is complete.</p>
        <div class="row center" style="justify-content:center">
          <button class="btn" onclick="setView('dash')">View Dashboard</button>
          <button class="btn" onclick="setView('corr')">See Correlations</button>
          <button class="btn ghost" onclick="setView('setup')">Adjust Setup</button>
        </div>
      </div></div>`;
      return;
    }

    const id=due[0]; const sc=SCALES.find(s=>s.id===id);
    const card=document.createElement("div"); card.className="card";
    card.innerHTML = `<div class="row"><h3 style="margin:0">${sc.title}</h3><span class="small muted">(${all.length-due.length+1} of ${all.length})</span></div>`;
    const form=document.createElement("form");
    sc.items.forEach((q,i)=>{
      const item=document.createElement("div"); item.className="item";
      const lab=document.createElement("label"); lab.textContent=`${i+1}. ${q}`; item.appendChild(lab);
      const row=document.createElement("div"); row.className="row";
      sc.choices.forEach(c=>{
        const l=document.createElement("label"); l.className="small"; l.style.cursor="pointer";
        l.innerHTML=`<input type="radio" name="${sc.id}_${i}" value="${c.v}" required> ${c.label}`;
        row.appendChild(l);
      });
      item.appendChild(row); form.appendChild(item);
    });
    const actions=document.createElement("div"); actions.className="row";
    const saveBtn=document.createElement("button"); saveBtn.type="submit"; saveBtn.className="btn primary"; saveBtn.textContent="Save & Continue";
    actions.appendChild(saveBtn); 
    form.appendChild(actions);

    form.onsubmit=(e)=>{
      e.preventDefault();
      const vals=sc.items.map((_,i)=>{ const el=form.querySelector(`input[name="${sc.id}_${i}"]:checked`); return el?Number(el.value):null; });
      if(vals.some(v=>v===null)){ alert("Please answer all items."); return; }
      const total=sc.score(vals);
      upsertEntry({week:w, scale:sc.id, total, answers:vals, savedAt:todayISO()});
      buildQueue(); // next item appears; this one disappears
    };

    card.appendChild(form);
    container.appendChild(card);
  }

  buildQueue();
  byId("weekPick").onchange=buildQueue;
  setInterval(()=>{
    const now=isoWeekKey(new Date());
    const el=byId("weekPick");
    if(el && el.value!==now){ el.value=now; buildQueue(); }
  }, 60_000);
}

/* =========================
   DASHBOARD
   ========================= */
function seriesFor(scaleId){ return state.data.filter(d=>d.scale===scaleId).sort((a,b)=>a.week.localeCompare(b.week)); }
function renderDash(){
  const p=byId("panel"); p.innerHTML="";
  const tabs=document.createElement("div"); tabs.className="row";
  (state.areas||[]).forEach(a=>{
    const b=document.createElement("button"); b.className="pill"; b.setAttribute("aria-pressed", a===currentArea);
    b.textContent=AREAS.find(x=>x.id===a).name;
    b.onclick=()=>{ currentArea=a; renderDash(); };
    tabs.appendChild(b);
  });
  p.appendChild(tabs);

  const ids=(state.assigned[currentArea]||[]);
  if(!ids.length){ p.innerHTML+=`<p class="muted">No tests assigned in this area. Use <strong>Setup</strong> to add some.</p>`; return; }

  ids.forEach(id=>{
    const sc=SCALES.find(s=>s.id===id);
    const pts=seriesFor(id);
    const max=sc.normMax || Math.max(1,...pts.map(p=>p.total));
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<div class="row"><strong>${sc.title}</strong><span class="small muted"> (0â€“${sc.normMax})</span></div>`;
    const bar=document.createElement("div"); bar.className="bar";
    pts.forEach(p=>{ const d=document.createElement("div"); d.style.height=Math.max(2,Math.round(p.total/max*120))+"px"; d.title=`${p.week}: ${p.total}`; bar.appendChild(d); });
    card.appendChild(bar);
    const meta=document.createElement("div"); meta.className="small muted";
    if(pts.length){ const last=pts.at(-1).total; const avg=(pts.reduce((a,b)=>a+b.total,0)/pts.length).toFixed(1); meta.textContent=`Last: ${last} Â· Avg: ${avg}`; } else { meta.textContent="No data yet."; }
    card.appendChild(meta);
    p.appendChild(card);
  });
}

/* =========================
   CORRELATIONS
   ========================= */
function renderCorr(){
  const p=byId("panel"); p.innerHTML="";
  const row=document.createElement("div"); row.className="row";
  const areaSel=document.createElement("select");
  (state.areas||[]).forEach(a=>{ const opt=document.createElement("option"); opt.value=a; opt.textContent=AREAS.find(x=>x.id===a).name; if(a===currentArea) opt.selected=true; areaSel.appendChild(opt); });
  areaSel.onchange=()=>{ currentArea=areaSel.value; renderCorr(); };
  row.innerHTML = `<h2 style="margin:0">Correlations</h2>`;
  row.appendChild(areaSel); p.appendChild(row);

  const ids=(state.assigned[currentArea]||[]);
  if(ids.length<2){ p.innerHTML+=`<p class="muted">Assign at least two tests in this area to view correlations.</p>`; return; }

  const table=document.createElement("table");
  table.innerHTML=`<thead><tr><th>Pair</th><th>r (all)</th><th>r (last 8)</th><th>r (last 4)</th></tr></thead><tbody id="corrBody"></tbody>`;
  p.appendChild(table);
  const body=byId("corrBody");

  function alignedTotals(aId,bId){
    const A=seriesFor(aId), B=seriesFor(bId);
    const mb=new Map(B.map(x=>[x.week,x.total]));
    const a=[],b=[];
    A.forEach(x=>{ if(mb.has(x.week)){ a.push(x.total); b.push(mb.get(x.week)); }});
    return [a,b];
  }
  function z(arr){ const m=arr.reduce((s,x)=>s+x,0)/arr.length; const sd=Math.sqrt(arr.reduce((s,x)=>s+(x-m)**2,0)/(arr.length||1)); return arr.map(x=> sd? (x-m)/sd : 0); }
  function corr(a,b){ if(a.length!==b.length||a.length<2) return null; const za=z(a), zb=z(b); return za.reduce((s,ai,i)=>s+ai*zb[i],0)/(za.length||1); }

  const ref=ids[0];
  ids.slice(1).forEach(other=>{
    const [A,B]=alignedTotals(ref,other);
    const all=corr(A,B), last8=corr(A.slice(-8),B.slice(-8)), last4=corr(A.slice(-4),B.slice(-4));
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${SCALES.find(s=>s.id===ref).title} â†” ${SCALES.find(s=>s.id===other).title}</td>
                  <td>${all==null?"â€“":all.toFixed(2)}</td>
                  <td>${last8==null?"â€“":last8.toFixed(2)}</td>
                  <td>${last4==null?"â€“":last4.toFixed(2)}</td>`;
    body.appendChild(tr);
  });
}

/* =========================
   DATA (export/import)
   ========================= */
function renderData(){
  const p=byId("panel"); p.innerHTML="";
  const card=document.createElement("div"); card.className="card";
  card.innerHTML=`<h2>Data</h2><p class="muted small">Export to back up. Import to restore. Local storage key: <code>${STORE_KEY}</code>.</p>`;
  const row=document.createElement("div"); row.className="row"; 
  const exp=document.createElement("button"); exp.className="btn"; exp.textContent="Export JSON";
  exp.onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`nspsycho_${todayISO()}.json`; a.click(); };
  const impLabel=document.createElement("label"); impLabel.className="btn ghost"; impLabel.textContent="Import JSON";
  const imp=document.createElement("input"); imp.type="file"; imp.accept=".json"; imp.style.display="none";
  imp.onchange=e=>{
    const f=e.target.files[0]; if(!f) return; const r=new FileReader();
    r.onload=()=>{ try{ const incoming=JSON.parse(r.result); if(incoming && incoming.data){ state=incoming; save(); renderData(); alert("Imported."); } else { alert("Invalid file."); } } catch{ alert("Invalid JSON."); } };
    r.readAsText(f);
  };
  impLabel.appendChild(imp);
  const clear=document.createElement("button"); clear.className="btn ghost"; clear.textContent="Clear ALL data";
  clear.onclick=()=>{ if(confirm("This clears ALL local data. Proceed?")){ localStorage.removeItem(STORE_KEY); state=load(); AREAS.forEach(a=>{ if(!state.assigned[a.id]) state.assigned[a.id]=DEFAULT_ASSIGN[a.id]||[]; }); save(); setView("setup"); } };
  row.appendChild(exp); row.appendChild(impLabel); row.appendChild(clear);
  card.appendChild(row);

  const t=document.createElement("table");
  t.innerHTML=`<thead><tr><th>Week</th><th>Scale</th><th>Score</th><th>Actions</th></tr></thead><tbody></tbody>`;
  const tb=t.querySelector("tbody");
  state.data.sort((a,b)=>a.week.localeCompare(b.week)).forEach((d,i)=>{
    const sc=SCALES.find(s=>s.id===d.scale);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${d.week}</td><td>${sc?sc.title:d.scale}</td><td>${d.total}</td><td><button class="btn small" data-i="${i}">Delete</button></td>`;
    tb.appendChild(tr);
  });
  t.onclick=e=>{
    if(e.target.tagName==="BUTTON"){ const idx=Number(e.target.dataset.i); if(confirm("Delete this entry?")){ state.data.splice(idx,1); save(); renderData(); } }
  };
  card.appendChild(t);
  p.appendChild(card);
}

/* =========================
   Start
   ========================= */
setView("setup");
</script>
</body>
</html>
