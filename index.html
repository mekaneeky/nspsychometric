<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NS Psycho â€” Weekly Tracker</title>
<style>
  :root {
    --fg:#0f172a;
    --bg:#f5f7fb;
    --surface:#ffffff;
    --surface-muted:#eef2fb;
    --muted:#667085;
    --line:rgba(15,23,42,0.08);
    --accent:#2563eb;
    --accent-soft:rgba(37,99,235,0.18);
    --ink:#0f172a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.6 "Inter","Segoe UI",Roboto,-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;-webkit-font-smoothing:antialiased}
  body{min-height:100vh}
  header{padding:18px 28px;background:var(--surface);display:flex;gap:16px;align-items:center;flex-wrap:wrap;position:sticky;top:0;z-index:20;border-bottom:1px solid var(--line);box-shadow:0 1px 0 rgba(15,23,42,0.04)}
  h1{font-size:20px;margin:0;font-weight:700;letter-spacing:-.01em;color:var(--fg)}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:none;background:transparent;padding:8px 14px;border-radius:999px;color:var(--muted);font-weight:600;letter-spacing:.01em;cursor:pointer;transition:background .2s,color .2s,transform .2s}
  .pill:hover{color:var(--fg);transform:translateY(-1px)}
  .pill[aria-pressed="true"]{background:var(--accent-soft);color:var(--accent)}
  main{max-width:1080px;margin:0 auto;padding:48px 24px 80px;display:block}
  h2{font-size:30px;margin:0 0 12px;font-weight:700;letter-spacing:-.02em}
  h3{font-size:18px;margin:16px 0 8px;font-weight:600;letter-spacing:-.01em;color:var(--fg)}
  p{margin:0 0 16px;color:var(--muted)}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:12px}
  .stack-lg{display:flex;flex-direction:column;gap:20px}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media (max-width:880px){.grid3{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:640px){header{padding:16px 20px}main{padding:32px 20px 64px}}
  .btn{border:1px solid transparent;background:var(--surface);color:var(--fg);padding:10px 18px;border-radius:12px;font-weight:600;letter-spacing:.01em;cursor:pointer;transition:background .2s,border .2s,box-shadow .2s,transform .2s;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{transform:translateY(-1px)}
  .btn:focus-visible{outline:none;box-shadow:0 0 0 3px var(--accent-soft)}
  .btn.primary{background:var(--accent);color:#fff;box-shadow:0 16px 30px -18px rgba(37,99,235,.6)}
  .btn.primary:hover{background:#1d4ed8}
  .btn.ghost{background:var(--surface-muted);color:var(--fg);border-color:transparent}
  .btn.ghost:hover{border-color:var(--accent-soft)}
  .btn.small{padding:6px 12px;font-size:13px}
  .btn.stretch{width:100%;justify-content:center}
  .chip{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 12px;margin:3px 6px 3px 0;cursor:pointer;background:var(--surface);color:var(--fg);font-size:13px;font-weight:500}
  .chip.on{border-color:var(--accent);background:var(--accent-soft);color:var(--accent)}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:600;color:var(--muted);background:var(--surface-muted);border:1px solid transparent;letter-spacing:.03em;text-transform:uppercase}
  .card{background:var(--surface);border-radius:20px;border:1px solid var(--line);padding:24px;box-shadow:0 30px 60px -50px rgba(15,23,42,.6)}
  .item{padding:12px 14px;border:1px solid var(--line);border-radius:12px;margin:8px 0;background:var(--surface)}
  label{display:block;font-size:14px;font-weight:600;color:var(--fg)}
  input,select,textarea{font:inherit}
  input[type="text"],input[type="date"],input[type="number"],input[type="search"],select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid transparent;background:var(--surface-muted);color:var(--fg);transition:background .2s,border .2s,box-shadow .2s}
  input[type="text"]:focus,input[type="date"]:focus,input[type="number"]:focus,input[type="search"]:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft);background:var(--surface)}
  textarea{resize:vertical;min-height:120px}
  table{border-collapse:collapse;width:100%;font-size:14px;background:var(--surface);border-radius:12px;overflow:hidden}
  th,td{border:1px solid var(--line);padding:10px 12px;text-align:left}
  .bar{height:160px;border:1px solid var(--line);border-radius:12px;display:flex;align-items:flex-end;gap:8px;padding:12px;overflow-x:auto;background:var(--surface)}
  .bar div{width:18px;border-radius:8px 8px 4px 4px;background:linear-gradient(180deg,var(--accent),rgba(37,99,235,.4))}
  .progress{height:8px;background:var(--surface-muted);border-radius:8px;overflow:hidden;border:1px solid var(--line)}
  .progress>div{height:8px;background:var(--accent)}
  .center{display:flex;justify-content:center;align-items:center;text-align:center}
  .overlay{border:1px solid var(--line);border-radius:16px;padding:28px;max-width:560px;margin:40px auto;background:var(--surface);box-shadow:0 28px 60px -48px rgba(15,23,42,.4)}
  .stepper{display:flex;gap:10px;align-items:center;margin:6px 0 16px}
  .step{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600}
  .dot{width:26px;height:26px;border-radius:50%;border:1px solid var(--line);display:inline-grid;place-items:center;font-size:12px;background:var(--surface)}
  .dot.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-soft)}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:var(--surface-muted);border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  .page-header{display:flex;flex-direction:column;gap:10px;margin-bottom:32px}
  .page-header p{max-width:540px;margin:0}
  .surface-block{background:var(--surface);border-radius:24px;border:1px solid var(--line);padding:28px;box-shadow:0 40px 70px -60px rgba(15,23,42,.6)}
  .journal-layout{display:grid;grid-template-columns:minmax(0,360px) minmax(0,1fr);gap:32px;align-items:flex-start}
  @media (max-width:1020px){.journal-layout{grid-template-columns:1fr}}
  .journal-form form{display:flex;flex-direction:column;gap:20px}
  .journal-log{display:flex;flex-direction:column;gap:20px}
  label.control,.control{display:flex;flex-direction:column;gap:8px;font-weight:600;font-size:13px;color:var(--fg);letter-spacing:.02em}
  label.control .field-label,.control .field-label{color:var(--muted);letter-spacing:.12em;font-size:11px;text-transform:uppercase}
  .field-input{border-radius:14px;padding:14px 16px;background:var(--surface-muted);border:1px solid transparent;color:var(--fg);font-weight:500}
  .field-input:focus{background:var(--surface);border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft);outline:none}
  select.field-input{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg fill="%23667085" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5"/></svg>');background-repeat:no-repeat;background-position:right 12px center;background-size:16px;padding-right:40px}
  .toggle{display:inline-flex;align-items:center;gap:12px;cursor:pointer;font-size:14px;font-weight:600;color:var(--fg)}
  .toggle input{appearance:none;width:44px;height:24px;border-radius:999px;background:var(--surface);border:1px solid var(--line);position:relative;transition:background .2s,border .2s}
  .toggle input::after{content:"";position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;top:1px;left:1px;box-shadow:0 2px 4px rgba(15,23,42,.15);transition:transform .2s}
  .toggle input:checked{background:var(--accent);border-color:var(--accent)}
  .toggle input:checked::after{transform:translateX(20px)}
  .toggle input:focus-visible{outline:none;box-shadow:0 0 0 3px var(--accent-soft)}
  .mood-control{gap:14px;padding:20px;background:var(--surface-muted);border-radius:20px;border:1px solid var(--line)}
  .mood-control .field-label{margin-bottom:-6px}
  .mood-control .mood-slider{display:flex;align-items:center;gap:16px}
  .mood-control input[type="range"]{width:100%;accent-color:var(--accent)}
  .mood-value{display:inline-flex;align-items:center;justify-content:center;min-width:88px;padding:10px 12px;border-radius:12px;background:var(--surface);border:1px solid var(--line);font-weight:600;color:var(--fg)}
  .mood-control.is-disabled{opacity:.6}
  .mood-control.is-disabled .mood-value{background:var(--surface-muted)}
  .session-fields{display:flex;flex-direction:column;gap:16px;background:var(--surface-muted);border-radius:20px;padding:20px;border:1px solid var(--line)}
  .session-fields .session-label{font-size:11px;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;font-weight:700}
  .session-fields .session-grid{display:flex;flex-direction:column;gap:16px}
  .form-actions{display:flex;flex-direction:column;gap:12px}
  .journal-log-header{display:flex;justify-content:space-between;gap:16px;align-items:flex-start}
  .journal-log-header h3{margin:0;font-size:20px}
  .journal-log-header .small{margin-top:4px}
  .journal-filters{display:flex;flex-wrap:wrap;gap:16px;background:var(--surface-muted);border-radius:20px;padding:18px;border:1px solid var(--line)}
  .journal-filters label.control{flex:1 1 200px}
  .journal-filters .field-input{background:var(--surface)}
  .journal-filters .field-input:focus{background:var(--surface)}
  .journal-list{display:flex;flex-direction:column;gap:18px}
  .journal-entry{border:1px solid transparent;border-radius:22px;padding:24px;background:var(--surface);box-shadow:0 24px 60px -48px rgba(15,23,42,.45);display:flex;flex-direction:column;gap:16px;transition:transform .2s,box-shadow .2s}
  .journal-entry:hover{transform:translateY(-2px);box-shadow:0 28px 70px -48px rgba(15,23,42,.5)}
  .entry-header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
  .entry-meta{display:flex;flex-direction:column;gap:6px}
  .entry-meta strong{font-size:15px;letter-spacing:.01em}
  .entry-badges{display:flex;gap:8px;flex-wrap:wrap}
  .entry-actions{display:flex;align-items:center;gap:10px;color:var(--muted);flex-wrap:wrap}
  .entry-time{color:var(--muted);font-size:12px;letter-spacing:.04em;text-transform:uppercase}
  .journal-entry h3{margin:0;font-size:20px;letter-spacing:-.01em}
  .journal-field{display:flex;flex-direction:column;gap:6px;padding:14px 16px;border-radius:16px;background:var(--surface-muted)}
  .journal-field strong{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
  .journal-field div{white-space:pre-wrap;font-size:14px;color:var(--fg)}
  .note-text{white-space:pre-wrap;font-size:15px;line-height:1.7;color:var(--fg)}
  .journal-tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{display:inline-flex;align-items:center;background:var(--accent-soft);border-radius:999px;padding:6px 12px;font-size:13px;color:var(--accent);font-weight:600}
  .mood-badge{display:inline-flex;align-items:center;gap:4px;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:600;color:#fff;letter-spacing:.02em;text-transform:uppercase}
  .mood-badge.low{background:#ef4444}
  .mood-badge.mid{background:#f59e0b;color:#111}
  .mood-badge.high{background:#22c55e}
  .journal-empty{padding:28px;border-radius:20px;border:1px dashed var(--line);text-align:center;color:var(--muted);background:var(--surface-muted)}
  .journal-entry .badge{background:var(--surface-muted);color:var(--muted)}
  .journal-entry .tag{background:var(--accent-soft)}
  .journal-entry .mood-badge{box-shadow:0 10px 20px -14px rgba(37,99,235,.5)}
  .entry-actions .btn.ghost{background:var(--surface)}
  @media (max-width:540px){.journal-entry{padding:20px}.journal-log-header{flex-direction:column;align-items:flex-start}.journal-filters{padding:16px}}
</style>
</head>
<body>
<header>
  <h1>NS Psychometric â€” Weekly Tracker</h1>
  <nav>
    <button class="pill" id="nav-setup" aria-pressed="true">Setup</button>
    <button class="pill" id="nav-checkin">Weekly Checkâ€‘In</button>
    <button class="pill" id="nav-dash">Dashboard</button>
    <button class="pill" id="nav-journal">Journaling</button>
    <button class="pill" id="nav-corr">Correlations</button>
    <button class="pill" id="nav-data">Data</button>
  </nav>
  <span class="small muted" style="margin-left:auto">All data stored locally</span>
</header>

<main>
  <section id="panel"></section>
</main>

<script>
/* =========================
   Utilities & Constants
   ========================= */
const byId=id=>document.getElementById(id);
const todayISO=()=>new Date().toISOString().slice(0,10);
function isoWeekKey(date=new Date()){
  const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
  const yStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const w=Math.ceil((((d-yStart)/86400000)+1)/7);
  return `${d.getUTCFullYear()}-W${String(w).padStart(2,'0')}`;
}
function weekKeyFromInput(val){ return val && /^\d{4}-W\d{2}$/.test(val) ? val : isoWeekKey(new Date()); }
const clamp=(val,min,max)=>Math.min(max,Math.max(min,val));
const makeId=(prefix)=>`${prefix}_${Math.random().toString(36).slice(2,8)}${Date.now().toString(36)}`;
const parseTags=str=>str.split(",").map(t=>t.trim()).filter(Boolean);
function toDisplayDate(dateStr){
  if(!dateStr) return "Unknown date";
  const d=new Date(dateStr);
  return Number.isNaN(d.getTime())?dateStr:d.toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"});
}
function toDisplayDateTime(dateStr){
  if(!dateStr) return "";
  const d=new Date(dateStr);
  return Number.isNaN(d.getTime())?dateStr:d.toLocaleString();
}

const AREAS=[
  {id:"wellbeing", name:"Wellâ€‘Being"},
  {id:"depression", name:"Depression"},
  {id:"anxiety", name:"Anxiety / Distress"},
  {id:"functioning", name:"Functioning"},
  {id:"resilience", name:"Resilience"},
  {id:"ptsd", name:"PTSD"},
  {id:"somatic", name:"Somatic"},
  {id:"eating", name:"Eating"},
  {id:"relationships", name:"Relationships / Attachment"},
  {id:"ocd", name:"OCD"},
  {id:"nondual", name:"Nonâ€‘dual / Nonattachment"},
];
const CHOICES={
  phq_gad:[{label:"Not at all",v:0},{label:"Several days",v:1},{label:"More than half the days",v:2},{label:"Nearly every day",v:3}],
  who5:[{label:"At no time",v:0},{label:"Some of the time",v:1},{label:"Less than half the time",v:2},{label:"More than half the time",v:3},{label:"Most of the time",v:4},{label:"All of the time",v:5}],
  k10:[{label:"None of the time",v:1},{label:"A little of the time",v:2},{label:"Some of the time",v:3},{label:"Most of the time",v:4},{label:"All of the time",v:5}],
  brs:[{label:"Strongly disagree",v:1},{label:"Disagree",v:2},{label:"Neutral",v:3},{label:"Agree",v:4},{label:"Strongly agree",v:5}],
  pcl5:[{label:"Not at all",v:0},{label:"A little bit",v:1},{label:"Moderately",v:2},{label:"Quite a bit",v:3},{label:"Extremely",v:4}],
  phq15:[{label:"Not bothered at all",v:0},{label:"Bothered a little",v:1},{label:"Bothered a lot",v:2}],
  yesno:[{label:"No",v:0},{label:"Yes",v:1}],
  whodas:[{label:"None",v:0},{label:"Mild",v:1},{label:"Moderate",v:2},{label:"Severe",v:3},{label:"Extreme / cannot do",v:4}],
  ecrs:[{label:"Strongly disagree",v:1},{label:"Disagree",v:2},{label:"Slightly disagree",v:3},{label:"Neutral",v:4},{label:"Slightly agree",v:5},{label:"Agree",v:6},{label:"Strongly agree",v:7}],
  nas7:[{label:"Strongly disagree",v:1},{label:"Disagree",v:2},{label:"Slightly disagree",v:3},{label:"Slightly agree",v:4},{label:"Agree",v:5},{label:"Strongly agree",v:6}],
  docsSF:[{label:"0",v:0},{label:"1",v:1},{label:"2",v:2},{label:"3",v:3},{label:"4",v:4},{label:"5",v:5},{label:"6",v:6},{label:"7",v:7},{label:"8",v:8}]
};
const SCALES=[
  {id:"PHQ8", title:"PHQâ€‘8 (Depression)", area:"depression", choices:CHOICES.phq_gad, normMax:24,
   items:["Little interest or pleasure in doing things.","Feeling down, depressed, or hopeless.","Trouble falling or staying asleep, or sleeping too much.","Feeling tired or having little energy.","Poor appetite or overeating.","Feeling bad about yourself â€” or that you are a failure or have let yourself or your family down.","Trouble concentrating on things, such as reading or watching television.","Moving or speaking so slowly that other people could have noticed â€” or the opposite: being so fidgety or restless that you have been moving around a lot more than usual."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"GAD7", title:"GADâ€‘7 (Anxiety)", area:"anxiety", choices:CHOICES.phq_gad, normMax:21,
   items:["Feeling nervous, anxious, or on edge.","Not being able to stop or control worrying.","Worrying too much about different things.","Trouble relaxing.","Being so restless that itâ€™s hard to sit still.","Becoming easily annoyed or irritable.","Feeling afraid as if something awful might happen."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"WHO5", title:"WHOâ€‘5 Wellâ€‘Being Index", area:"wellbeing", choices:CHOICES.who5, normMax:100,
   items:["I have felt cheerful and in good spirits.","I have felt calm and relaxed.","I have felt active and vigorous.","I woke up feeling fresh and rested.","My daily life has been filled with things that interest me."],
   score:vals=>Math.round(vals.reduce((a,b)=>a+b,0)*4)},
  {id:"K10", title:"K10 (Psychological Distress)", area:"anxiety", choices:CHOICES.k10, normMax:50,
   items:["During the last 30 days, about how often did you feel tired out for no good reason?","During the last 30 days, about how often did you feel nervous?","â€¦so nervous that nothing could calm you down?","â€¦hopeless?","â€¦restless or fidgety?","â€¦so restless you could not sit still?","â€¦depressed?","â€¦that everything was an effort?","â€¦so sad that nothing could cheer you up?","â€¦worthless?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"BRS6", title:"Brief Resilience Scale (6)", area:"resilience", choices:CHOICES.brs, normMax:30,
   items:["I tend to bounce back quickly after hard times.","I have a hard time making it through stressful events.","It does not take me long to recover from a stressful event.","It is hard for me to snap back when something bad happens.","I usually come through difficult times with little trouble.","I tend to take a long time to get over setâ€‘backs in my life."],
   score:vals=>{const rev=[1,3,5];return vals.map((v,i)=>rev.includes(i)?(6-v):v).reduce((a,b)=>a+b,0)}},
  {id:"WHODAS12", title:"WHODAS 2.0 (12â€‘item)", area:"functioning", choices:CHOICES.whodas, normMax:48,
   items:["Standing for long periods such as 30 minutes?","Taking care of your household responsibilities?","Learning a new task, for example, learning how to get to a new place?","Joining in community activities in the same way as anyone else can?","How much have you been emotionally affected by your health problems?","Concentrating on doing something for ten minutes?","Walking a long distance such as a kilometre [or equivalent]?","Washing your whole body?","Getting dressed?","Dealing with people you do not know?","Maintaining a friendship?","Your dayâ€‘toâ€‘day work?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"PHQ15", title:"PHQâ€‘15 (Somatic Symptoms)", area:"somatic", choices:CHOICES.phq15, normMax:30,
   items:["Stomach pain","Back pain","Pain in your arms, legs, or joints (knees, hips, etc.)","Menstrual cramps or other problems with your periods (women only â€” if not applicable choose â€˜Not bothered at allâ€™)","Headaches","Chest pain","Dizziness","Fainting spells","Feeling your heart pound or race","Shortness of breath","Pain or problems during sexual intercourse","Constipation, loose bowels, or diarrhea","Nausea, gas, or indigestion","Feeling tired or having low energy","Trouble sleeping"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"SCOFF", title:"SCOFF (Eatingâ€‘Disorder Screen)", area:"eating", choices:CHOICES.yesno, normMax:5,
   items:["Do you make yourself Sick because you feel uncomfortably full?","Do you worry you have lost Control over how much you eat?","Have you recently lost more than One stone (â‰ˆ6.5â€¯kg) in a threeâ€‘month period?","Do you believe yourself to be Fat when others say you are too thin?","Would you say that Food dominates your life?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"PCL5", title:"PCLâ€‘5 (PTSD, past month)", area:"ptsd", choices:CHOICES.pcl5, normMax:80,
   items:["Repeated, disturbing, and unwanted memories of the stressful experience?","Repeated, disturbing dreams of the stressful experience?","Suddenly feeling or acting as if the stressful experience were actually happening again?","Feeling very upset when something reminded you of the stressful experience?","Having strong physical reactions when something reminded you of the stressful experience (for example, heart pounding, trouble breathing, sweating)?","Avoiding memories, thoughts, or feelings related to the stressful experience?","Avoiding external reminders of the stressful experience (for example, people, places, conversations, activities, objects, or situations)?","Trouble remembering important parts of the stressful experience?","Having strong negative beliefs about yourself, other people, or the world?","Blaming yourself or someone else for the stressful experience or what happened after it?","Having strong negative feelings such as fear, horror, anger, guilt, or shame?","Loss of interest in activities that you used to enjoy?","Feeling distant or cut off from other people?","Trouble experiencing positive feelings (for example, being unable to feel happiness or have loving feelings for people close to you)?","Irritable behavior, angry outbursts, or acting aggressively?","Taking too many risks or doing things that could cause you harm?","Being â€œsuperalertâ€ or watchful or on guard?","Feeling jumpy or easily startled?","Having difficulty concentrating?","Trouble falling or staying asleep?"],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"ECRS12", title:"ECRâ€‘S (Attachment, 12)", area:"relationships", choices:CHOICES.ecrs, normMax:84,
   items:["It helps to turn to my romantic partner in times of need.","I need a lot of reassurance that I am loved by my partner.","I want to get close to my partner, but I keep pulling back.","I find that my partner(s) donâ€™t want to get as close as I would like.","I turn to my partner for many things, including comfort and reassurance.","My desire to be very close sometimes scares people away.","I try to avoid getting too close to my partner.","I do not often worry about being abandoned.","I usually discuss my problems and concerns with my partner.","I get frustrated if romantic partners are not available when I need them.","I am nervous when partners get too close to me.","I worry that romantic partners wonâ€™t care about me as much as I care about them."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"NAS7", title:"NASâ€‘7 (Nonâ€‘attachment)", area:"nondual", choices:CHOICES.nas7, normMax:42,
   items:["I can let go of regrets and feelings of dissatisfaction about the past.","I can enjoy pleasant experiences without needing them to last forever.","I view the problems that enter my life as things to work on rather than reasons for becoming disheartened or demoralized.","I can enjoy my family and friends without feeling I need to hang on to them.","I can take joy in othersâ€™ achievements without feeling envious.","I do not get â€œhung upâ€ on wanting an â€œidealâ€ or â€œperfectâ€ life.","When pleasant experiences end, I am fine moving on to what comes next."],
   score:vals=>vals.reduce((a,b)=>a+b,0)},
  {id:"DOCS_SF5", title:"OCD Severity (DOCSâ€‘SF style, 5)", area:"ocd", choices:CHOICES.docsSF, normMax:40,
   items:["Past 7 days: time occupied by obsessions/compulsions.","Past 7 days: avoidance due to obsessions/compulsions.","Past 7 days: distress from obsessions/compulsions.","Past 7 days: interference with daily life (home, work, social).","Past 7 days: difficulty refraining from compulsions."],
   score:vals=>vals.reduce((a,b)=>a+b,0)}
];
const DEFAULT_ASSIGN={
  wellbeing:["WHO5","NAS7"],
  depression:["PHQ8"],
  anxiety:["GAD7","K10"],
  functioning:["WHODAS12"],
  resilience:["BRS6"],
  ptsd:["PCL5"],
  somatic:["PHQ15"],
  eating:["SCOFF"],
  relationships:["ECRS12"],
  ocd:["DOCS_SF5"],
  nondual:["NAS7"]
};
const STORE_KEY="nspsycho_v3";
const AREA_MAP=new Map(AREAS.map(a=>[a.id,a]));
const SCALE_MAP=new Map(SCALES.map(s=>[s.id,s]));

/* =========================
   State Normalisation & Storage
   ========================= */
function normalizeJournalEntry(entry,idx){
  if(!entry||typeof entry!=="object") return null;
  const normalized={...entry};
  normalized.id=typeof entry.id==="string"?entry.id:`legacy_${idx}_${Date.now().toString(36)}`;
  normalized.date=entry.date||todayISO();
  normalized.type=entry.type==="session"?"session":entry.type==="general"?"general":"mood";
  const mood=Number(entry.mood);
  normalized.mood=Number.isFinite(mood)?clamp(Math.round(mood),1,10):null;
  normalized.title=entry.title?String(entry.title):"";
  normalized.protocol=entry.protocol?String(entry.protocol):"";
  normalized.effects=entry.effects?String(entry.effects):(entry.outcome?String(entry.outcome):"");
  normalized.notes=entry.notes?String(entry.notes):"";
  if(Array.isArray(entry.tags)) normalized.tags=entry.tags.map(t=>String(t)).filter(Boolean);
  else if(typeof entry.tags==="string") normalized.tags=parseTags(entry.tags);
  else normalized.tags=[];
  normalized.savedAt=entry.savedAt||entry.createdAt||new Date().toISOString();
  return normalized;
}
function applyStateInvariants(state){
  if(!state||typeof state!=="object") state={};
  state.areas=Array.isArray(state.areas)?state.areas.filter(id=>AREA_MAP.has(id)):[];
  if(!state.areas.length) state.areas=["wellbeing"];
  state.areas=Array.from(new Set(state.areas));
  if(typeof state.assigned!=="object"||state.assigned===null) state.assigned={};
  AREAS.forEach(area=>{
    const arr=Array.isArray(state.assigned[area.id])?state.assigned[area.id].filter(id=>{
      const sc=SCALE_MAP.get(id);
      return sc&&sc.area===area.id;
    }):[];
    state.assigned[area.id]=arr.length?Array.from(new Set(arr)):[...(DEFAULT_ASSIGN[area.id]||[])];
  });
  if(!Array.isArray(state.data)) state.data=[];
  state.data=state.data.filter(entry=>entry&&entry.scale&&(entry.week||entry.date)).map(entry=>{
    const clone={...entry};
    if(!clone.week&&clone.date) clone.week=isoWeekKey(new Date(clone.date));
    clone.savedAt=clone.savedAt||todayISO();
    return clone;
  });
  if(typeof state.meta!=="object"||state.meta===null) state.meta={};
  if(!Array.isArray(state.journal)) state.journal=[];
  state.journal=state.journal.map((entry,idx)=>normalizeJournalEntry(entry,idx)).filter(Boolean);
  state.journal.sort((a,b)=>{
    if(a.date===b.date) return (b.savedAt||"").localeCompare(a.savedAt||"");
    return b.date.localeCompare(a.date);
  });
  return state;
}
const Storage={
  KEY:STORE_KEY,
  load(){
    try{
      const raw=JSON.parse(localStorage.getItem(this.KEY));
      return this.normalize(raw);
    }catch{
      return this.normalize({});
    }
  },
  save(state){ localStorage.setItem(this.KEY, JSON.stringify(state)); },
  normalize(raw){
    const base=raw&&typeof raw==="object"?{...raw}:{};
    return applyStateInvariants(base);
  }
};
const State=(()=>{
  let data=Storage.load();
  const listeners=new Set();
  function notify(){ listeners.forEach(fn=>fn(data)); }
  return {
    get:()=>data,
    mutate(fn){
      fn(data);
      applyStateInvariants(data);
      Storage.save(data);
      notify();
    },
    replace(raw){
      data=Storage.normalize(raw);
      Storage.save(data);
      notify();
    },
    subscribe(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
  };
})();

/* =========================
   Derived Helpers
   ========================= */
const DataHelpers={
  selectedScaleIds(){
    const ids=new Set();
    const state=State.get();
    (state.areas||[]).forEach(area=>{
      (state.assigned[area]||[]).forEach(id=>ids.add(id));
    });
    return Array.from(ids);
  },
  upsertEntry(entry){
    State.mutate(state=>{
      const idx=state.data.findIndex(d=>d.week===entry.week&&d.scale===entry.scale);
      if(idx>=0) state.data[idx]={...state.data[idx],...entry};
      else state.data.push(entry);
    });
  },
  seriesFor(scaleId){
    return State.get().data.filter(d=>d.scale===scaleId).sort((a,b)=>a.week.localeCompare(b.week));
  }
};

/* =========================
   UI State
   ========================= */
const UIState=(()=>{
  let setupStep=1;
  let currentArea=State.get().areas[0]||"wellbeing";
  return {
    get setupStep(){ return setupStep; },
    set setupStep(step){ setupStep=step; },
    nextSetup(){ if(setupStep<3) setupStep+=1; },
    prevSetup(){ if(setupStep>1) setupStep-=1; },
    ensureArea(){
      const areas=State.get().areas;
      if(!areas.includes(currentArea)) currentArea=areas[0]||"wellbeing";
    },
    get currentArea(){ this.ensureArea(); return currentArea; },
    set currentArea(area){ currentArea=area; }
  };
})();
State.subscribe(()=>UIState.ensureArea());

let renderCurrentView=()=>{};
let goToView=()=>{};

/* =========================
   Views
   ========================= */
const SetupView={
  render(container){
    const stepper=document.createElement("div"); stepper.className="stepper";
    stepper.innerHTML=`
      <div class="step"><div class="dot ${UIState.setupStep===1?'active':''}">1</div> Areas</div>
      <div style="width:24px;height:1px;background:var(--line)"></div>
      <div class="step"><div class="dot ${UIState.setupStep===2?'active':''}">2</div> Tests</div>
      <div style="width:24px;height:1px;background:var(--line)"></div>
      <div class="step"><div class="dot ${UIState.setupStep===3?'active':''}">3</div> Review</div>`;
    container.appendChild(stepper);

    const body=document.createElement("div"); body.id="setupBody"; container.appendChild(body);
    if(UIState.setupStep===1) this.renderAreas(body);
    if(UIState.setupStep===2) this.renderTests(body);
    if(UIState.setupStep===3) this.renderReview(body);
  },
  renderAreas(container){
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h2>Choose focus areas</h2><p class="muted">Pick the domains you want to track weekly.</p>`;
    const grid=document.createElement("div"); grid.className="grid3";
    const state=State.get();
    AREAS.forEach(area=>{
      const wrap=document.createElement("div");
      const button=document.createElement("button");
      const active=state.areas.includes(area.id);
      button.className="pill"; button.setAttribute("aria-pressed",active);
      button.textContent=area.name;
      button.onclick=()=>{
        State.mutate(s=>{
          const idx=s.areas.indexOf(area.id);
          if(idx>=0){
            if(s.areas.length===1) return;
            s.areas.splice(idx,1);
          }else{
            s.areas.push(area.id);
          }
        });
        UIState.ensureArea();
        renderCurrentView();
      };
      wrap.appendChild(button);
      grid.appendChild(wrap);
    });
    card.appendChild(grid);

    const row=document.createElement("div"); row.className="row"; row.style.marginTop="12px";
    const next=document.createElement("button"); next.className="btn primary"; next.textContent="Next: Choose Tests";
    next.onclick=()=>{ UIState.nextSetup(); renderCurrentView(); };
    row.appendChild(next);
    card.appendChild(row);
    container.appendChild(card);
  },
  renderTests(container){
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h2>Choose tests per area</h2><p class="muted">Toggle any assessments you want to include in your weekly checkâ€‘in.</p>`;
    const state=State.get();
    state.areas.forEach(areaId=>{
      const areaCard=document.createElement("div"); areaCard.className="card"; areaCard.style.marginTop="10px";
      areaCard.innerHTML=`<strong>${AREA_MAP.get(areaId).name}</strong>`;

      const controls=document.createElement("div"); controls.className="row";
      const selectAll=document.createElement("button"); selectAll.className="btn ghost"; selectAll.textContent="Select All";
      selectAll.onclick=()=>{
        State.mutate(s=>{ s.assigned[areaId]=SCALES.filter(sc=>sc.area===areaId).map(sc=>sc.id); });
        renderCurrentView();
      };
      const clear=document.createElement("button"); clear.className="btn ghost"; clear.textContent="Clear All";
      clear.onclick=()=>{
        State.mutate(s=>{ s.assigned[areaId]=[]; });
        renderCurrentView();
      };
      const restore=document.createElement("button"); restore.className="btn ghost"; restore.textContent="Restore Recommended";
      restore.onclick=()=>{
        State.mutate(s=>{ s.assigned[areaId]=[...(DEFAULT_ASSIGN[areaId]||[])]; });
        renderCurrentView();
      };
      controls.appendChild(selectAll); controls.appendChild(clear); controls.appendChild(restore);
      areaCard.appendChild(controls);

      const chips=document.createElement("div");
      const selected=new Set(state.assigned[areaId]||[]);
      SCALES.filter(sc=>sc.area===areaId).forEach(sc=>{
        const chip=document.createElement("span"); chip.className="chip"+(selected.has(sc.id)?" on":"");
        chip.textContent=sc.title;
        chip.onclick=()=>{
          State.mutate(s=>{
            const set=new Set(s.assigned[areaId]||[]);
            if(set.has(sc.id)) set.delete(sc.id); else set.add(sc.id);
            s.assigned[areaId]=Array.from(set);
          });
          renderCurrentView();
        };
        chips.appendChild(chip);
      });
      areaCard.appendChild(chips);
      card.appendChild(areaCard);
    });

    const row=document.createElement("div"); row.className="row"; row.style.marginTop="12px";
    const back=document.createElement("button"); back.className="btn"; back.textContent="Back"; back.onclick=()=>{ UIState.prevSetup(); renderCurrentView(); };
    const next=document.createElement("button"); next.className="btn primary"; next.textContent="Next: Review"; next.onclick=()=>{ UIState.nextSetup(); renderCurrentView(); };
    row.appendChild(back); row.appendChild(next);
    card.appendChild(row);
    container.appendChild(card);
  },
  renderReview(container){
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h2>Review & Save</h2><p class="muted">These tests will appear in your Weekly Checkâ€‘In each week.</p>`;
    const table=document.createElement("table");
    table.innerHTML=`<thead><tr><th>Area</th><th>Assigned tests</th></tr></thead><tbody></tbody>`;
    const tbody=table.querySelector("tbody");
    const state=State.get();
    state.areas.forEach(area=>{
      const tr=document.createElement("tr");
      const tests=(state.assigned[area]||[]).map(id=>SCALE_MAP.get(id)?.title||id).join(", ");
      tr.innerHTML=`<td>${AREA_MAP.get(area).name}</td><td>${tests||"<span class='muted'>None</span>"}</td>`;
      tbody.appendChild(tr);
    });
    card.appendChild(table);

    const row=document.createElement("div"); row.className="row"; row.style.marginTop="12px";
    const back=document.createElement("button"); back.className="btn"; back.textContent="Back"; back.onclick=()=>{ UIState.prevSetup(); renderCurrentView(); };
    const saveBtn=document.createElement("button"); saveBtn.className="btn primary"; saveBtn.textContent="Save & Start Weekly Checkâ€‘In";
    saveBtn.onclick=()=>{ goToView("checkin"); };
    row.appendChild(back); row.appendChild(saveBtn);
    card.appendChild(row);

    const note=document.createElement("p"); note.className="small muted";
    note.innerHTML="Tip: You can edit assignments anytime in <strong>Setup</strong>. Data stays on this device.";
    card.appendChild(note);
    container.appendChild(card);
  }
};

const CheckinView=(()=>{
  let weekWatcher=null;
  function ensureWatcher(weekInput,buildQueue){
    if(weekWatcher) clearInterval(weekWatcher);
    weekWatcher=setInterval(()=>{
      const now=isoWeekKey(new Date());
      if(weekInput.value!==now){ weekInput.value=now; buildQueue(); }
    },60_000);
  }
  return {
    render(container){
      const week=isoWeekKey(new Date());
      const head=document.createElement("div"); head.className="row";
      head.innerHTML=`<h2 style="margin:0">Weekly Checkâ€‘In</h2>`;
      const pickerWrap=document.createElement("div"); pickerWrap.className="row";
      const label=document.createElement("label"); label.className="small"; label.textContent="Week ";
      const weekInput=document.createElement("input"); weekInput.type="week"; weekInput.value=week; weekInput.id="weekPick";
      label.appendChild(weekInput);
      const reset=document.createElement("button"); reset.className="btn ghost"; reset.textContent="Reset this week";
      reset.onclick=()=>{
        const targetWeek=weekKeyFromInput(weekInput.value);
        if(confirm(`Clear all responses for ${targetWeek}?`)){
          State.mutate(state=>{ state.data=state.data.filter(d=>d.week!==targetWeek); });
          buildQueue();
        }
      };
      pickerWrap.appendChild(label); pickerWrap.appendChild(reset);
      container.appendChild(head); container.appendChild(pickerWrap);

      const prog=document.createElement("div"); prog.className="progress"; prog.innerHTML=`<div id="progFill" style="width:0%"></div>`;
      const progText=document.createElement("div"); progText.className="small muted"; progText.id="progText"; progText.style.marginTop="6px"; progText.textContent="0 of 0 completed";
      container.appendChild(prog); container.appendChild(progText);

      const queueContainer=document.createElement("div"); queueContainer.id="queueContainer"; container.appendChild(queueContainer);

      const buildQueue=()=>{
        const state=State.get();
        const w=weekKeyFromInput(weekInput.value);
        const all=DataHelpers.selectedScaleIds();
        const done=new Set(state.data.filter(d=>d.week===w).map(d=>d.scale));
        const due=all.filter(id=>!done.has(id));
        const pct=all.length?Math.round((all.length-due.length)/all.length*100):0;
        byId("progFill").style.width=pct+"%";
        progText.textContent=`${all.length-due.length} of ${all.length} completed`;
        queueContainer.innerHTML="";

        if(all.length===0){
          queueContainer.innerHTML=`<div class="overlay center"><div>
            <h2>No tests are assigned</h2>
            <p class="muted">Use <strong>Setup</strong> to choose areas and tests.</p>
            <button class="btn primary" onclick="return false;">Go to Setup</button>
          </div></div>`;
          const btn=queueContainer.querySelector("button");
          if(btn) btn.onclick=()=>goToView("setup");
          return;
        }
        if(due.length===0){
          queueContainer.innerHTML=`<div class="overlay center"><div>
            <h2>ðŸŽ‰ All caught up</h2>
            <p class="muted">Week <strong>${w}</strong> is complete.</p>
            <div class="row center" style="justify-content:center">
              <button class="btn" data-nav="dash">View Dashboard</button>
              <button class="btn" data-nav="corr">See Correlations</button>
              <button class="btn ghost" data-nav="setup">Adjust Setup</button>
            </div>
          </div></div>`;
          queueContainer.querySelectorAll("button[data-nav]").forEach(btn=>{
            btn.onclick=()=>goToView(btn.dataset.nav);
          });
          return;
        }

        const id=due[0];
        const sc=SCALE_MAP.get(id);
        const card=document.createElement("div"); card.className="card";
        card.innerHTML=`<div class="row"><h3 style="margin:0">${sc.title}</h3><span class="small muted">(${all.length-due.length+1} of ${all.length})</span></div>`;
        const form=document.createElement("form");
        sc.items.forEach((q,i)=>{
          const item=document.createElement("div"); item.className="item";
          const lab=document.createElement("label"); lab.textContent=`${i+1}. ${q}`; item.appendChild(lab);
          const row=document.createElement("div"); row.className="row";
          sc.choices.forEach(choice=>{
            const l=document.createElement("label"); l.className="small"; l.style.cursor="pointer";
            l.innerHTML=`<input type="radio" name="${sc.id}_${i}" value="${choice.v}" required> ${choice.label}`;
            row.appendChild(l);
          });
          item.appendChild(row);
          form.appendChild(item);
        });
        const actions=document.createElement("div"); actions.className="row";
        const saveBtn=document.createElement("button"); saveBtn.type="submit"; saveBtn.className="btn primary"; saveBtn.textContent="Save & Continue";
        actions.appendChild(saveBtn); form.appendChild(actions);

        form.onsubmit=e=>{
          e.preventDefault();
          const vals=sc.items.map((_,i)=>{
            const el=form.querySelector(`input[name="${sc.id}_${i}"]:checked`);
            return el?Number(el.value):null;
          });
          if(vals.some(v=>v===null)){ alert("Please answer all items."); return; }
          const total=sc.score(vals);
          DataHelpers.upsertEntry({week:w, scale:sc.id, total, answers:vals, savedAt:new Date().toISOString()});
          buildQueue();
        };

        card.appendChild(form);
        queueContainer.appendChild(card);
      };

      buildQueue();
      weekInput.onchange=buildQueue;
      ensureWatcher(weekInput,buildQueue);
    }
  };
})();

const DashboardView={
  render(container){
    const state=State.get();
    const tabs=document.createElement("div"); tabs.className="row";
    (state.areas||[]).forEach(area=>{
      const btn=document.createElement("button"); btn.className="pill"; btn.setAttribute("aria-pressed", area===UIState.currentArea);
      btn.textContent=AREA_MAP.get(area).name;
      btn.onclick=()=>{ UIState.currentArea=area; renderCurrentView(); };
      tabs.appendChild(btn);
    });
    container.appendChild(tabs);

    const ids=state.assigned[UIState.currentArea]||[];
    if(!ids.length){
      const msg=document.createElement("p"); msg.className="muted"; msg.innerHTML="No tests assigned in this area. Use <strong>Setup</strong> to add some.";
      container.appendChild(msg);
      return;
    }

    ids.forEach(id=>{
      const sc=SCALE_MAP.get(id);
      const pts=DataHelpers.seriesFor(id);
      const max=sc.normMax||Math.max(1,...pts.map(p=>p.total));
      const card=document.createElement("div"); card.className="card";
      card.innerHTML=`<div class="row"><strong>${sc.title}</strong><span class="small muted"> (0â€“${sc.normMax})</span></div>`;
      const bar=document.createElement("div"); bar.className="bar";
      pts.forEach(p=>{
        const d=document.createElement("div");
        d.style.height=Math.max(2,Math.round(p.total/max*120))+"px";
        d.title=`${p.week}: ${p.total}`;
        bar.appendChild(d);
      });
      card.appendChild(bar);
      const meta=document.createElement("div"); meta.className="small muted";
      if(pts.length){
        const last=pts.at(-1).total;
        const avg=(pts.reduce((a,b)=>a+b.total,0)/pts.length).toFixed(1);
        meta.textContent=`Last: ${last} Â· Avg: ${avg}`;
      }else{
        meta.textContent="No data yet.";
      }
      card.appendChild(meta);
      container.appendChild(card);
    });
  }
};

const CorrView={
  render(container){
    const state=State.get();
    const row=document.createElement("div"); row.className="row";
    const areaSel=document.createElement("select");
    (state.areas||[]).forEach(area=>{
      const opt=document.createElement("option"); opt.value=area; opt.textContent=AREA_MAP.get(area).name; if(area===UIState.currentArea) opt.selected=true; areaSel.appendChild(opt);
    });
    areaSel.onchange=()=>{ UIState.currentArea=areaSel.value; renderCurrentView(); };
    const heading=document.createElement("h2"); heading.style.margin="0"; heading.textContent="Correlations";
    row.appendChild(heading); row.appendChild(areaSel); container.appendChild(row);

    const ids=(state.assigned[UIState.currentArea]||[]);
    if(ids.length<2){
      const msg=document.createElement("p"); msg.className="muted"; msg.innerHTML="Assign at least two tests in this area to view correlations.";
      container.appendChild(msg);
      return;
    }

    const table=document.createElement("table");
    table.innerHTML=`<thead><tr><th>Pair</th><th>r (all)</th><th>r (last 8)</th><th>r (last 4)</th></tr></thead><tbody></tbody>`;
    const body=table.querySelector("tbody");

    function alignedTotals(aId,bId){
      const A=DataHelpers.seriesFor(aId), B=DataHelpers.seriesFor(bId);
      const mapB=new Map(B.map(x=>[x.week,x.total]));
      const a=[],b=[];
      A.forEach(x=>{ if(mapB.has(x.week)){ a.push(x.total); b.push(mapB.get(x.week)); }});
      return [a,b];
    }
    function z(arr){ const m=arr.reduce((s,x)=>s+x,0)/arr.length; const sd=Math.sqrt(arr.reduce((s,x)=>s+(x-m)**2,0)/(arr.length||1)); return arr.map(x=> sd? (x-m)/sd : 0); }
    function corr(a,b){ if(a.length!==b.length||a.length<2) return null; const za=z(a), zb=z(b); return za.reduce((s,ai,i)=>s+ai*zb[i],0)/(za.length||1); }

    const ref=ids[0];
    ids.slice(1).forEach(other=>{
      const [A,B]=alignedTotals(ref,other);
      const all=corr(A,B), last8=corr(A.slice(-8),B.slice(-8)), last4=corr(A.slice(-4),B.slice(-4));
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${SCALE_MAP.get(ref).title} â†” ${SCALE_MAP.get(other).title}</td>
                    <td>${all==null?"â€“":all.toFixed(2)}</td>
                    <td>${last8==null?"â€“":last8.toFixed(2)}</td>
                    <td>${last4==null?"â€“":last4.toFixed(2)}</td>`;
      body.appendChild(tr);
    });
    container.appendChild(table);
  }
};

function computeJournalStats(entries){
  const moods=entries.filter(e=>typeof e.mood==="number");
  const last7=moods.slice(0,7);
  const avg7=last7.length? (last7.reduce((s,e)=>s+e.mood,0)/last7.length).toFixed(1):null;
  const sessionCount=entries.filter(e=>e.type==="session").length;
  return {total:entries.length, avg7, sessionCount, moodsLogged:moods.length};
}
function moodBadgeClass(mood){ if(typeof mood!=="number") return "mid"; if(mood<=4) return "low"; if(mood<=7) return "mid"; return "high"; }
function describeEntryType(type){
  switch(type){
    case "session": return "Session / Protocol";
    case "general": return "General Note";
    default: return "Mood Check-In";
  }
}

const JournalView=(()=>{
  const filters={type:"all",search:""};
  function renderList(container,summary,resultsInfo){
    const entries=State.get().journal;
    const query=filters.search.trim().toLowerCase();
    const filtered=entries.filter(entry=>{
      if(filters.type!=="all" && entry.type!==filters.type) return false;
      if(query){
        const haystack=[entry.title,entry.notes,entry.protocol,entry.effects,entry.tags.join(" ")].join(" \n").toLowerCase();
        if(!haystack.includes(query)) return false;
      }
      return true;
    });

    const stats=computeJournalStats(entries);
    if(summary){
      summary.textContent = stats.total
        ? `Logged ${stats.total} entries â€¢ Mood avg (last 7): ${stats.avg7??"â€“"} â€¢ Protocol sessions: ${stats.sessionCount}`
        : "No entries yet. Start by logging your first mood or reflection.";
    }
    if(resultsInfo){
      resultsInfo.textContent = filtered.length===entries.length
        ? `${filtered.length} entries`
        : `Showing ${filtered.length} of ${entries.length} entries`;
    }

    container.innerHTML="";
    if(!filtered.length){
      const empty=document.createElement("div"); empty.className="journal-empty"; empty.textContent="Nothing logged with the current filters.";
      container.appendChild(empty);
      return;
    }

    filtered.forEach(entry=>{
      const card=document.createElement("article"); card.className="journal-entry";

      const header=document.createElement("div"); header.className="entry-header";
      const left=document.createElement("div"); left.className="entry-meta";
      const date=document.createElement("strong"); date.textContent=toDisplayDate(entry.date);
      const sub=document.createElement("div"); sub.className="entry-badges";
      const typeBadge=document.createElement("span"); typeBadge.className="badge"; typeBadge.textContent=describeEntryType(entry.type);
      sub.appendChild(typeBadge);
      if(entry.mood!==null && entry.mood!==undefined){
        const mood=document.createElement("span"); mood.className=`mood-badge ${moodBadgeClass(entry.mood)}`;
        mood.textContent=`Mood ${entry.mood}/10`;
        sub.appendChild(mood);
      }
      left.appendChild(date); left.appendChild(sub);
      header.appendChild(left);

      const actionsWrap=document.createElement("div"); actionsWrap.className="entry-actions";
      const time=document.createElement("span"); time.className="entry-time"; time.textContent=`Logged ${toDisplayDateTime(entry.savedAt)}`;
      actionsWrap.appendChild(time);
      const del=document.createElement("button"); del.type="button"; del.className="btn ghost small"; del.textContent="Delete";
      del.onclick=()=>{
        if(confirm("Delete this journal entry?")){
          State.mutate(state=>{ state.journal=state.journal.filter(e=>e.id!==entry.id); });
          renderList(container,summary,resultsInfo);
        }
      };
      actionsWrap.appendChild(del);
      header.appendChild(actionsWrap);
      card.appendChild(header);

      const title=document.createElement("h3"); title.textContent=entry.title||describeEntryType(entry.type);
      card.appendChild(title);

      if(entry.type==="session" && entry.protocol){
        const field=document.createElement("div"); field.className="journal-field";
        const strong=document.createElement("strong"); strong.textContent="Protocol";
        const val=document.createElement("div"); val.textContent=entry.protocol;
        field.appendChild(strong); field.appendChild(val); card.appendChild(field);
      }
      if(entry.type==="session" && entry.effects){
        const field=document.createElement("div"); field.className="journal-field";
        const strong=document.createElement("strong"); strong.textContent="Effects & observations";
        const val=document.createElement("div"); val.textContent=entry.effects;
        field.appendChild(strong); field.appendChild(val); card.appendChild(field);
      }
      if(entry.notes){
        const note=document.createElement("div"); note.className="note-text"; note.textContent=entry.notes;
        card.appendChild(note);
      }
      if(entry.tags && entry.tags.length){
        const tags=document.createElement("div"); tags.className="journal-tags";
        entry.tags.forEach(tag=>{ const span=document.createElement("span"); span.className="tag"; span.textContent=tag; tags.appendChild(span); });
        card.appendChild(tags);
      }

      container.appendChild(card);
    });
  }
  return {
    render(container){
      const header=document.createElement("div"); header.className="page-header";
      const title=document.createElement("h2"); title.textContent="Journaling";
      const intro=document.createElement("p"); intro.textContent="Log mood check-ins, sessions, and reflections to see how your wellbeing evolves over time.";
      header.appendChild(title); header.appendChild(intro);
      container.appendChild(header);

      const layout=document.createElement("div"); layout.className="journal-layout";
      container.appendChild(layout);

      const formCard=document.createElement("div"); formCard.className="surface-block journal-form";
      const formTitle=document.createElement("h3"); formTitle.textContent="Add an entry"; formCard.appendChild(formTitle);
      const form=document.createElement("form"); formCard.appendChild(form);
      layout.appendChild(formCard);

      const dateLabel=document.createElement("label"); dateLabel.className="control";
      const dateLabelText=document.createElement("span"); dateLabelText.className="field-label"; dateLabelText.textContent="Entry date";
      const dateInput=document.createElement("input"); dateInput.type="date"; dateInput.value=todayISO(); dateInput.className="field-input";
      dateLabel.appendChild(dateLabelText); dateLabel.appendChild(dateInput); form.appendChild(dateLabel);

      const typeLabel=document.createElement("label"); typeLabel.className="control";
      const typeLabelText=document.createElement("span"); typeLabelText.className="field-label"; typeLabelText.textContent="Entry type";
      const typeSelect=document.createElement("select"); typeSelect.className="field-input";
      [{value:"mood",label:"Mood check-in"},{value:"session",label:"Session / protocol"},{value:"general",label:"General reflection"}]
        .forEach(opt=>{ const option=document.createElement("option"); option.value=opt.value; option.textContent=opt.label; typeSelect.appendChild(option); });
      typeLabel.appendChild(typeLabelText); typeLabel.appendChild(typeSelect); form.appendChild(typeLabel);

      const moodWrap=document.createElement("div"); moodWrap.className="control mood-control";
      const moodLabel=document.createElement("span"); moodLabel.className="field-label"; moodLabel.textContent="Mood check-in";
      moodWrap.appendChild(moodLabel);
      const moodToggle=document.createElement("input"); moodToggle.type="checkbox"; moodToggle.checked=true; moodToggle.id="moodToggle";
      const moodToggleLabel=document.createElement("label"); moodToggleLabel.className="toggle";
      moodToggleLabel.appendChild(moodToggle);
      const moodToggleText=document.createElement("span"); moodToggleText.textContent="Include mood rating";
      moodToggleLabel.appendChild(moodToggleText);
      moodWrap.appendChild(moodToggleLabel);
      const sliderRow=document.createElement("div"); sliderRow.className="mood-slider";
      const moodInput=document.createElement("input"); moodInput.type="range"; moodInput.min="1"; moodInput.max="10"; moodInput.value="5"; moodInput.setAttribute("aria-label","Mood rating");
      const moodValue=document.createElement("span"); moodValue.className="mood-value"; moodValue.textContent="5 / 10";
      sliderRow.appendChild(moodInput); sliderRow.appendChild(moodValue);
      moodWrap.appendChild(sliderRow);
      form.appendChild(moodWrap);
      const toggleMood=()=>{
        const enabled=moodToggle.checked;
        moodInput.disabled=!enabled;
        moodWrap.classList.toggle("is-disabled",!enabled);
        moodValue.textContent = enabled ? `${moodInput.value} / 10` : "Not recorded";
      };
      moodToggle.addEventListener("change",toggleMood);
      moodInput.addEventListener("input",()=>{ moodValue.textContent=`${moodInput.value} / 10`; });
      toggleMood();

      const titleLabel=document.createElement("label"); titleLabel.className="control";
      const titleLabelText=document.createElement("span"); titleLabelText.className="field-label"; titleLabelText.textContent="Title or short summary";
      const titleInput=document.createElement("input"); titleInput.type="text"; titleInput.placeholder="Optional"; titleInput.className="field-input";
      titleLabel.appendChild(titleLabelText); titleLabel.appendChild(titleInput); form.appendChild(titleLabel);

      const sessionWrap=document.createElement("div"); sessionWrap.className="session-fields";
      const sessionHeading=document.createElement("div"); sessionHeading.className="session-label"; sessionHeading.textContent="Session details";
      sessionWrap.appendChild(sessionHeading);
      const sessionGrid=document.createElement("div"); sessionGrid.className="session-grid";
      sessionWrap.appendChild(sessionGrid);
      const protocolLabel=document.createElement("label"); protocolLabel.className="control";
      const protocolLabelText=document.createElement("span"); protocolLabelText.className="field-label"; protocolLabelText.textContent="Protocol or focus";
      const protocolInput=document.createElement("input"); protocolInput.type="text"; protocolInput.placeholder="e.g. Alpha uptrain"; protocolInput.className="field-input";
      protocolLabel.appendChild(protocolLabelText); protocolLabel.appendChild(protocolInput);
      const effectsLabel=document.createElement("label"); effectsLabel.className="control";
      const effectsLabelText=document.createElement("span"); effectsLabelText.className="field-label"; effectsLabelText.textContent="Immediate effects";
      const effectsInput=document.createElement("textarea"); effectsInput.rows=3; effectsInput.placeholder="What did you notice during or after the session?"; effectsInput.className="field-input";
      effectsLabel.appendChild(effectsLabelText); effectsLabel.appendChild(effectsInput);
      sessionGrid.appendChild(protocolLabel); sessionGrid.appendChild(effectsLabel);
      form.appendChild(sessionWrap);

      const notesLabel=document.createElement("label"); notesLabel.className="control";
      const notesLabelText=document.createElement("span"); notesLabelText.className="field-label"; notesLabelText.textContent="Notes";
      const notesInput=document.createElement("textarea"); notesInput.rows=4; notesInput.placeholder="Feelings, wins, triggers, gratitudeâ€¦"; notesInput.className="field-input";
      notesLabel.appendChild(notesLabelText); notesLabel.appendChild(notesInput); form.appendChild(notesLabel);

      const tagsLabel=document.createElement("label"); tagsLabel.className="control";
      const tagsLabelText=document.createElement("span"); tagsLabelText.className="field-label"; tagsLabelText.textContent="Tags (comma separated)";
      const tagsInput=document.createElement("input"); tagsInput.type="text"; tagsInput.placeholder="sleep, focus, gratitude"; tagsInput.className="field-input";
      tagsLabel.appendChild(tagsLabelText); tagsLabel.appendChild(tagsInput); form.appendChild(tagsLabel);

      const saveRow=document.createElement("div"); saveRow.className="form-actions";
      const saveBtn=document.createElement("button"); saveBtn.type="submit"; saveBtn.className="btn primary stretch"; saveBtn.textContent="Save entry";
      saveRow.appendChild(saveBtn);
      form.appendChild(saveRow);

      const toggleSessionFields=()=>{
        sessionWrap.style.display = typeSelect.value==="session"?"flex":"none";
      };
      typeSelect.onchange=toggleSessionFields;
      toggleSessionFields();

      form.onsubmit=e=>{
        e.preventDefault();
        const entry={
          id:makeId("journal"),
          date:dateInput.value||todayISO(),
          type:typeSelect.value,
          title:titleInput.value.trim(),
          notes:notesInput.value.trim(),
          protocol:typeSelect.value==="session"?protocolInput.value.trim():"",
          effects:typeSelect.value==="session"?effectsInput.value.trim():"",
          mood:moodToggle.checked?Number(moodInput.value):null,
          tags:parseTags(tagsInput.value),
          savedAt:new Date().toISOString()
        };
        State.mutate(state=>{ state.journal.unshift(entry); });
        dateInput.value=todayISO();
        typeSelect.value="mood";
        titleInput.value="";
        notesInput.value="";
        protocolInput.value="";
        effectsInput.value="";
        tagsInput.value="";
        moodInput.value="5";
        moodToggle.checked=true;
        toggleMood();
        toggleSessionFields();
        renderList(listContainer,summary,resultsInfo);
      };

      const logCard=document.createElement("div"); logCard.className="surface-block journal-log";
      layout.appendChild(logCard);
      const logHeader=document.createElement("div"); logHeader.className="journal-log-header";
      const logTitle=document.createElement("h3"); logTitle.textContent="Journal history";
      const summary=document.createElement("div"); summary.className="small muted";
      logHeader.appendChild(logTitle); logHeader.appendChild(summary);
      logCard.appendChild(logHeader);

      const filtersRow=document.createElement("div"); filtersRow.className="journal-filters";
      const typeFilterLabel=document.createElement("label"); typeFilterLabel.className="control";
      const typeFilterLabelText=document.createElement("span"); typeFilterLabelText.className="field-label"; typeFilterLabelText.textContent="Type";
      const typeFilter=document.createElement("select"); typeFilter.className="field-input";
      [{value:"all",label:"All entries"},{value:"mood",label:"Mood check-ins"},{value:"session",label:"Sessions"},{value:"general",label:"General notes"}]
        .forEach(opt=>{ const option=document.createElement("option"); option.value=opt.value; option.textContent=opt.label; if(opt.value===filters.type) option.selected=true; typeFilter.appendChild(option); });
      typeFilter.onchange=()=>{ filters.type=typeFilter.value; renderList(listContainer,summary,resultsInfo); };
      typeFilterLabel.appendChild(typeFilterLabelText); typeFilterLabel.appendChild(typeFilter); filtersRow.appendChild(typeFilterLabel);

      const searchLabel=document.createElement("label"); searchLabel.className="control";
      const searchLabelText=document.createElement("span"); searchLabelText.className="field-label"; searchLabelText.textContent="Search";
      const searchInput=document.createElement("input"); searchInput.type="search"; searchInput.placeholder="mood, focus, tagâ€¦"; searchInput.value=filters.search; searchInput.className="field-input";
      searchInput.oninput=()=>{ filters.search=searchInput.value; renderList(listContainer,summary,resultsInfo); };
      searchLabel.appendChild(searchLabelText); searchLabel.appendChild(searchInput); filtersRow.appendChild(searchLabel);
      logCard.appendChild(filtersRow);

      const resultsInfo=document.createElement("div"); resultsInfo.className="small muted";
      logCard.appendChild(resultsInfo);

      const listContainer=document.createElement("div"); listContainer.className="journal-list"; logCard.appendChild(listContainer);

      renderList(listContainer,summary,resultsInfo);
    }
  };
})();

const DataView={
  render(container){
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h2>Data</h2><p class="muted small">Export to back up. Import to restore. Local storage key: <code>${STORE_KEY}</code>.</p>`;
    const row=document.createElement("div"); row.className="row";
    const exp=document.createElement("button"); exp.className="btn"; exp.textContent="Export JSON";
    exp.onclick=()=>{
      const blob=new Blob([JSON.stringify(State.get(),null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`nspsycho_${todayISO()}.json`; a.click();
    };
    const impLabel=document.createElement("label"); impLabel.className="btn ghost"; impLabel.textContent="Import JSON";
    const imp=document.createElement("input"); imp.type="file"; imp.accept=".json"; imp.style.display="none";
    imp.onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const incoming=JSON.parse(r.result);
          if(incoming&&typeof incoming==="object"){
            State.replace(incoming);
            alert("Imported.");
            renderCurrentView();
          }else{ alert("Invalid file."); }
        }catch{ alert("Invalid JSON."); }
      };
      r.readAsText(f);
    };
    impLabel.appendChild(imp);
    const clear=document.createElement("button"); clear.className="btn ghost"; clear.textContent="Clear ALL data";
    clear.onclick=()=>{
      if(confirm("This clears ALL local data. Proceed?")){
        localStorage.removeItem(STORE_KEY);
        State.replace({});
        goToView("setup");
      }
    };
    row.appendChild(exp); row.appendChild(impLabel); row.appendChild(clear);
    card.appendChild(row);

    const entries=[...State.get().data].sort((a,b)=>a.week.localeCompare(b.week)||a.scale.localeCompare(b.scale));
    const table=document.createElement("table");
    table.innerHTML=`<thead><tr><th>Week</th><th>Scale</th><th>Score</th><th>Actions</th></tr></thead><tbody></tbody>`;
    const tb=table.querySelector("tbody");
    entries.forEach(entry=>{
      const sc=SCALE_MAP.get(entry.scale);
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${entry.week}</td><td>${sc?sc.title:entry.scale}</td><td>${entry.total}</td><td><button class="btn small ghost" data-week="${entry.week}" data-scale="${entry.scale}">Delete</button></td>`;
      tb.appendChild(tr);
    });
    table.onclick=e=>{
      if(e.target.tagName==="BUTTON"){
        const week=e.target.dataset.week;
        const scale=e.target.dataset.scale;
        if(confirm("Delete this entry?")){
          State.mutate(state=>{ state.data=state.data.filter(d=>!(d.week===week&&d.scale===scale)); });
          renderCurrentView();
        }
      }
    };
    card.appendChild(table);

    const journalEntries=State.get().journal;
    const journalTable=document.createElement("table");
    journalTable.style.marginTop="20px";
    journalTable.innerHTML=`<thead><tr><th>Date</th><th>Type</th><th>Mood</th><th>Title</th><th>Tags</th><th>Actions</th></tr></thead><tbody></tbody>`;
    const jt=journalTable.querySelector("tbody");
    journalEntries.forEach(entry=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${entry.date}</td><td>${describeEntryType(entry.type)}</td><td>${entry.mood??"â€“"}</td><td>${entry.title||"â€”"}</td><td>${entry.tags.join(", ")}</td><td><button class="btn small ghost" data-journal="${entry.id}">Delete</button></td>`;
      jt.appendChild(tr);
    });
    journalTable.onclick=e=>{
      if(e.target.tagName==="BUTTON"){
        const id=e.target.dataset.journal;
        if(confirm("Delete this journal entry?")){
          State.mutate(state=>{ state.journal=state.journal.filter(entry=>entry.id!==id); });
          renderCurrentView();
        }
      }
    };
    card.appendChild(journalTable);

    container.appendChild(card);
  }
};

const Views={
  setup:SetupView,
  checkin:CheckinView,
  dash:DashboardView,
  journal:JournalView,
  corr:CorrView,
  data:DataView
};

/* =========================
   Router & Boot
   ========================= */
const Router=(()=>{
  let current="setup";
  const panel=byId("panel");
  const navButtons={
    setup:byId("nav-setup"),
    checkin:byId("nav-checkin"),
    dash:byId("nav-dash"),
    journal:byId("nav-journal"),
    corr:byId("nav-corr"),
    data:byId("nav-data")
  };
  Object.entries(navButtons).forEach(([id,btn])=>{
    if(btn) btn.onclick=()=>set(id);
  });
  function set(view){
    current=view;
    updateNav();
    render();
  }
  function updateNav(){
    Object.entries(navButtons).forEach(([id,btn])=>{
      if(btn) btn.setAttribute("aria-pressed", id===current);
    });
  }
  function render(){
    panel.innerHTML="";
    Views[current].render(panel);
  }
  return { set, get:()=>current, render };
})();
renderCurrentView=()=>Router.render();
goToView=view=>Router.set(view);
Router.set("setup");
</script>
</body>
</html>
